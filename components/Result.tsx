
import React, { useEffect, useState, useMemo } from 'react';
import { ConflictStyle } from '../types';
import { STYLE_DETAILS } from '../constants';
import { getPersonalizedInsights } from '../services/geminiService';
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, ResponsiveContainer } from 'recharts';

interface ResultProps {
  scores: Record<ConflictStyle, number>;
  userName: string;
  onReset: () => void;
}

const Result: React.FC<ResultProps> = ({ scores, userName, onReset }) => {
  const [insight, setInsight] = useState<string | null>(null);
  const [loadingInsight, setLoadingInsight] = useState(true);

  const topStyle = useMemo(() => {
    return (Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0]) as ConflictStyle;
  }, [scores]);

  const chartData = useMemo(() => {
    return Object.entries(scores).map(([style, score]) => ({
      subject: STYLE_DETAILS[style as ConflictStyle].name,
      A: score,
      fullMark: 12,
    }));
  }, [scores]);

  useEffect(() => {
    const fetchInsight = async () => {
      setLoadingInsight(true);
      const text = await getPersonalizedInsights(scores, topStyle, userName);
      setInsight(text);
      setLoadingInsight(false);
    };
    fetchInsight();
  }, [scores, topStyle, userName]);

  const meta = STYLE_DETAILS[topStyle];

  const handleDownload = () => {
    const date = new Date().toLocaleDateString();
    const scoreSummary = Object.entries(scores)
      .map(([style, score]) => `${style}: ${score}/12`)
      .join('\n');

    const reportContent = `
TKI CONFLICT MODE ASSESSMENT REPORT
----------------------------------
Prepared for: ${userName}
Date: ${date}
Primary Conflict Mode: ${meta.name} (${meta.archetype})

SUMMARY OF SCORES:
${scoreSummary}

ABOUT YOUR PRIMARY MODE (${meta.name}):
${meta.description}

STRENGTHS:
${meta.strengths.map(s => `- ${s}`).join('\n')}

POTENTIAL RISKS:
${meta.weaknesses.map(w => `- ${w}`).join('\n')}

AI PERSONALIZED INTERPRETATION:
------------------------------
${insight || 'Insights still loading...'}

----------------------------------
Generated by TKI Assessment Tool
    `.trim();

    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `TKI_Report_${userName.replace(/\s+/g, '_')}_${date.replace(/\//g, '-')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="max-w-5xl mx-auto px-6 py-16 animate-in fade-in duration-1000">
      <div className="text-center mb-16 print:mb-8">
        <span className="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full font-bold text-sm mb-4 print:hidden">
          Profile for {userName}
        </span>
        <h1 className="text-5xl font-extrabold mb-4 print:text-3xl">
          Primary Mode: <span style={{ color: meta.color }}>{meta.name}</span>
        </h1>
        <p className="text-xl text-slate-600 max-w-2xl mx-auto print:text-base">
          {meta.description}
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start mb-20 print:gap-4 print:mb-8">
        {/* Radar Chart */}
        <div className="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 print:shadow-none print:border-slate-200 print:rounded-2xl print:p-4">
          <h3 className="text-xl font-bold mb-8 text-center print:mb-4 print:text-lg">TKI Profile</h3>
          <div className="h-[400px] w-full print:h-[300px]">
            <ResponsiveContainer width="100%" height="100%">
              <RadarChart cx="50%" cy="50%" outerRadius="80%" data={chartData}>
                <PolarGrid stroke="#e2e8f0" />
                <PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 11, fontWeight: 700 }} />
                <Radar
                  name="Score"
                  dataKey="A"
                  stroke={meta.color}
                  fill={meta.color}
                  fillOpacity={0.6}
                />
              </RadarChart>
            </ResponsiveContainer>
          </div>
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-8 print:mt-4">
            {Object.entries(scores).map(([style, score]) => {
              const sMeta = STYLE_DETAILS[style as ConflictStyle];
              return (
                <div key={style} className="text-center p-3 rounded-2xl bg-slate-50 border border-slate-100 print:p-2 print:rounded-xl">
                  <div className="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">{sMeta.name}</div>
                  <div className="text-2xl font-bold print:text-xl" style={{ color: sMeta.color }}>{score}</div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Detailed Style Info */}
        <div className="space-y-8 print:space-y-4">
          <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 print:shadow-none print:border-slate-200 print:rounded-2xl print:p-4">
            <h3 className="text-2xl font-bold mb-6 flex items-center gap-3 print:text-lg print:mb-3">
              <span className="text-3xl print:hidden">{meta.icon}</span> Understanding {meta.name}
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 print:gap-4">
              <div>
                <h4 className="text-sm font-bold uppercase tracking-wider text-emerald-600 mb-3 print:mb-1 print:text-[10px]">Key Strengths</h4>
                <ul className="space-y-2 print:space-y-1">
                  {meta.strengths.map(s => (
                    <li key={s} className="flex items-center gap-2 text-slate-700 print:text-xs">
                      <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 print:hidden"></div> {s}
                    </li>
                  ))}
                </ul>
              </div>
              <div>
                <h4 className="text-sm font-bold uppercase tracking-wider text-rose-600 mb-3 print:mb-1 print:text-[10px]">Potential Risks</h4>
                <ul className="space-y-2 print:space-y-1">
                  {meta.weaknesses.map(w => (
                    <li key={w} className="flex items-center gap-2 text-slate-700 print:text-xs">
                      <div className="w-1.5 h-1.5 rounded-full bg-rose-500 print:hidden"></div> {w}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>

          <div className="bg-indigo-900 text-indigo-50 p-8 rounded-[2.5rem] shadow-xl shadow-indigo-100 relative overflow-hidden print:bg-slate-50 print:text-slate-900 print:shadow-none print:border print:border-slate-200 print:rounded-2xl print:p-4">
             <div className="absolute top-0 right-0 p-4 text-indigo-800 opacity-20 text-8xl pointer-events-none font-black italic print:hidden">TKI</div>
             <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 relative z-10 print:text-lg print:mb-2">
               <span className="animate-pulse print:hidden">âœ¨</span> Feedback for {userName}
             </h3>
             {loadingInsight ? (
               <div className="flex flex-col gap-3 py-4 animate-pulse print:hidden">
                 <div className="h-4 bg-indigo-800/50 rounded w-full"></div>
                 <div className="h-4 bg-indigo-800/50 rounded w-5/6"></div>
                 <div className="h-4 bg-indigo-800/50 rounded w-4/6"></div>
               </div>
             ) : (
               <div className="text-indigo-100/90 leading-relaxed text-lg whitespace-pre-line relative z-10 print:text-slate-700 print:text-sm">
                 {insight}
               </div>
             )}
          </div>
        </div>
      </div>

      <div className="flex flex-col md:flex-row items-center justify-center gap-4 pt-10 border-t border-slate-200 print:hidden">
        <button 
          onClick={onReset}
          className="px-8 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all active:scale-95"
        >
          Retake TKI
        </button>
        <button 
          onClick={handleDownload}
          className="flex items-center gap-2 px-8 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 active:scale-95"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
          Download Report (.txt)
        </button>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-8 py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
          Save as PDF
        </button>
      </div>
    </div>
  );
};

export default Result;
